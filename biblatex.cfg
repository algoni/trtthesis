\usepackage{xpatch}

% ------------
% Bibliography style modifications
% using the xpatch package. Commands:
% \xpatchbibmacro{<name>}{<search>}{<replace>}{<success>}{<failure>}
% \xpretobibmacro{<name>}{<code to prepend>}{<success>}{<failure>}
% \xapptobibmacro{<name>}{<code to append>}{<success>}{<failure>}
% ------------

% Hanging indent
\setlength{\bibhang}{\ifnumequal{\parindent}{0}{1.27cm}{\parindent}}

% No parens around publication year
\xpatchbibmacro{date+extrayear}{%
	\printtext[parens]%
}{%
\setunit{\addperiod\space}%
\printtext%
}{}{}

% Separate location and publisher with a comma instead of a colon
\xpatchbibmacro{publisher+location+date}{\addcolon}{\addcomma}{}{}

% Title: no quotes or italics
\DeclareFieldFormat*{title}{#1}

% All authors listed as Surname, Initial
\DeclareNameFormat{last-first}{%
	\iffirstinits
	{\usebibmacro{name:last-first}{#1}{#4}{#5}{#7}}
	{\usebibmacro{name:last-first}{#1}{#3}{#5}{#7}}%
	\usebibmacro{name:andothers}}
\renewcommand*{\finalnamedelim}{%
	\ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}%
	\space\&\space
}
\DeclareNameAlias{sortname}{last-first}

% Volume and number formatting for periodical publications
\DeclareFieldFormat[article,periodical]{volume}{\bibstring{volumes}\space#1}
\DeclareFieldFormat[article,periodical]{number}{\mkbibparens{#1}}

\renewbibmacro*{volume+number+eid}{%
	\printfield{volume}%
	\printfield{number}%
	\setunit{\addcomma\space}%
	\printfield{eid}
}{}{}
\DeclareFieldFormat{journaltitle}{#1\newunitpunct}

% ------------
% Citations
%
% \longcite command: used when a citation refers to multiple sentences in the paper.
% ------------

\DeclareCiteCommand*{\parencite}[\mkbibparens]
 	{\usebibmacro{prenote}}
 	{%
		\usebibmacro{citeindex}%
		\usebibmacro{cite}%
	}
	{\multicitedelim}
	{\usebibmacro{postnote}.}

\DeclareCiteCommand{\fullcite}
	{\defcounter{maxnames}{\blx@maxbibnames}%
		\usebibmacro{prenote}}
	{\usedriver
		{\DeclareNameAlias{sortname}{last-first}}
		{\thefield{entrytype}}
	}
	{\multicitedelim}
	{\usebibmacro{postnote}}

% Using \parencite as the default citation style
\renewcommand{\cite}{\parencite}
\renewcommand*{\cite}{\parencite}
\renewcommand{\cites}{\parencites}

% ------------
% Localisation
%
% Modifications to default Finnish translation of BibLaTeX
% ------------

\DefineBibliographyStrings{finnish}{%
	bibliography = {LÃ¤hteet},
	in = {}
}

% Pages as "ss." 
\DeclareFieldFormat{pages}{ss.\ppspace#1}
\DeclareFieldFormat{pagetotal}{\mkpagetotal[bookpagination]{#1}}
